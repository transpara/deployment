version: "3.9"
   
services:

  tgraph-database:
    labels:
      - "Version=${IMAGE_TAG}"
      - "ID=${TCORE_ID}"
    image: "transpara/tgraph-database:${IMAGE_TAG}"
    volumes:
      - tcore_data:/var/lib/memgraph
    container_name: ${TCORE_NAME}_tcore_db
    ports:
      - "0.0.0.0:${TCORE_GRAPH_UI_PORT}:3000"
    restart: unless-stopped

  tcore-api:
    image: "transpara/tcore-api:develop"
    environment:
      - TGRAPH_HOST=${TCORE_NAME}_tcore_db
      - TGRAPH_PORT=7687
      - REDIS_HOST=${TCACHE_HOST}
      - REDIS_PORT=6379  
      - CELERY_BROKER_URL=redis://${TCACHE_HOST}:6379/0
      - CELERY_RESULT_BACKEND=redis://${TCACHE_HOST}:6379/1 
      - TAUTH_HOST=${TAUTH_HOST}
      - TAUTH_PORT=8080
      - TCORE_ID=${TCORE_ID}
    container_name: ${TCORE_NAME}_tcore-api
    hostname: ${TCORE_NAME}_tcore-api
    ports:
      - "0.0.0.0:${TCORE_PORT}:80"
    restart: unless-stopped
    logging: 
      driver: syslog
      options:
        syslog-address: "udp://${SYSLOG_HOST}:514"
        syslog-format: "rfc3164"
        tag: "node-${TCORE_NAME}_tcore-api"

  tcore-beat:
    image: "transpara/tcore-api:develop"  
    command: /app/run-celerybeat.sh
    container_name: ${TCORE_NAME}_tcore-beat
    hostname: ${TCORE_NAME}_tcore-beat
    restart: unless-stopped     
    environment:
      - TGRAPH_HOST=${TCORE_NAME}_tcore_db
      - TGRAPH_PORT=7687    
      - CELERY_BROKER_URL=redis://${TCACHE_HOST}:6379/0
      - CELERY_RESULT_BACKEND=redis://${TCACHE_HOST}:6379/1          
      - REDIS_HOST=${TCACHE_HOST}
      - REDIS_PORT=6379   
      - TAUTH_HOST=${TAUTH_HOST}
      - TAUTH_PORT=8080     
      - TCORE_ID=${TCORE_ID}
    logging: 
      driver: syslog
      options:
        syslog-address: "udp://${SYSLOG_HOST}:514"
        syslog-format: "rfc3164"
        tag: "node-${TCORE_NAME}_tcore-beat"      

  tcore-worker:
    image: "transpara/tcore-api:develop"  
    command: /app/run-celeryworker.sh
    container_name: ${TCORE_NAME}_tcore-worker
    hostname: ${TCORE_NAME}_tcore-worker
    restart: unless-stopped     
    environment:
      - TGRAPH_HOST=${TCORE_NAME}_tcore_db
      - TGRAPH_PORT=7687    
      - CELERY_BROKER_URL=redis://${TCACHE_HOST}:6379/0
      - CELERY_RESULT_BACKEND=redis://${TCACHE_HOST}:6379/1      
      - REDIS_HOST=${TCACHE_HOST}
      - REDIS_PORT=6379              
      - TAUTH_HOST=${TAUTH_HOST}
      - TAUTH_PORT=8080
      - TCORE_ID=${TCORE_ID}
    logging: 
      driver: syslog
      options:
        syslog-address: "udp://${SYSLOG_HOST}:514"
        syslog-format: "rfc3164"
        tag: "node-${TCORE_NAME}_tcore-worker"     

  tcore-flower:
    image: "transpara/tcore-api:develop"  
    command: /app/run-flower.sh
    container_name: ${TCORE_NAME}_tcore-flower
    hostname: ${TCORE_NAME}_tcore-flower
    ports:
      - "${FLOWER_PORT}:5555"    
    restart: unless-stopped     
    environment:
      - CELERY_BROKER_URL=redis://${TCACHE_HOST}:6379/0
      - CELERY_RESULT_BACKEND=redis://${TCACHE_HOST}:6379/1
    logging: 
      driver: syslog
      options:
        syslog-address: "udp://${SYSLOG_HOST}:514"
        syslog-format: "rfc3164"
        tag: "node-${TCORE_NAME}_tcore-flower"    

  tcore-ui:
    image: transpara/tcore-ui:develop
    container_name: ${TCORE_NAME}_tcore-ui
    ports:
      - '10101:3000'
    environment:
      - NEXT_PUBLIC_API_URL=http://${TCORE_HOST}:${TCORE_PORT}/api/v1
      - NEXT_PUBLIC_SOCKET_URL=http://${TCORE_HOST}:${TCORE_PORT}

networks:
   default:
      name: transpara

volumes:
  tcore_data: 
      name: tcore_data_${TCORE_ID}
  tauth_data: 
      name: tauth_data
